<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <title>Mantenimiento Waldorf ¬∑ Colaboraci√≥n compartida</title>
    <!-- Librer√≠a para Google Sheets -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        /* Mismo estilo Waldorf, mobile-first */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #f9f3e9;
            font-family: 'Atkinson Hyperlegible', 'Segoe UI', Roboto, -apple-system, sans-serif;
            line-height: 1.5;
            color: #3e2e23;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .waldorf-wrapper {
            max-width: 800px;
            width: 100%;
        }

        h1 {
            font-size: 2.4rem;
            font-weight: 400;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #5e4b3a;
            border-bottom: 3px solid #dbb88c;
            display: inline-block;
            padding-bottom: 0.25rem;
            margin-bottom: 2rem;
            margin-top: 0.5rem;
            text-shadow: 2px 2px 0 rgba(235, 205, 167, 0.3);
            word-break: break-word;
        }

        .area {
            background: rgba(255, 247, 240, 0.7);
            border-radius: 32px 12px 32px 12px;
            padding: 1.5rem 1.2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 18px -6px rgba(120, 90, 70, 0.12);
            border: 1px solid #e6d8c5;
        }

        h2 {
            font-size: 1.8rem;
            font-weight: 380;
            color: #7a5a44;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-left: 10px solid #c7aa82;
            padding-left: 0.75rem;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            margin-top: 0.8rem;
        }

        .task-item {
            background: #fffefc;
            padding: 1rem 1.1rem;
            border-radius: 20px 8px 20px 8px;
            border: 1px solid #eedccb;
            box-shadow: 3px 3px 0 #e2cfbc;
        }

        .task-name {
            font-weight: 600;
            font-size: 1.2rem;
            color: #4a3729;
            display: block;
            margin-bottom: 0.75rem;
            border-bottom: 1px dashed #d9b8a4;
            padding-bottom: 0.4rem;
        }

        .contribution-form {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
            margin: 0.8rem 0 0.6rem;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.4rem 0.8rem;
        }

        label {
            font-size: 0.9rem;
            color: #69554a;
            font-weight: 500;
            min-width: 50px;
        }

        input {
            background: #fefcf7;
            border: 1px solid #d6c0ad;
            border-radius: 30px;
            padding: 0.7rem 1rem;
            font-size: 1rem;
            flex: 1 1 180px;
            font-family: inherit;
            border: 1.5px solid #e3cebc;
        }

        input:focus {
            border-color: #b4835c;
            outline: none;
            background-color: #fff9f2;
            box-shadow: 0 0 0 3px rgba(180, 140, 100, 0.15);
        }

        .btn {
            background: #ebdac9;
            border: none;
            border-radius: 50px;
            padding: 0.7rem 1.3rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: #3a2e25;
            border-bottom: 4px solid #bcaa96;
            align-self: flex-start;
            transition: 0.07s;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5cfbc;
            border-bottom-width: 4px;
        }

        .btn:hover {
            background: #e2cfbc;
            border-bottom-width: 2px;
            transform: translateY(2px);
            border-bottom-color: #9f8b7a;
        }

        .contributors-wall {
            margin-top: 1.1rem;
            background: #f7efe7;
            padding: 0.9rem 1rem;
            border-radius: 18px;
            border-left: 8px solid #c6a882;
            font-size: 0.95rem;
        }

        .wall-title {
            font-weight: 600;
            color: #624c3c;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 0.6rem;
            font-size: 1rem;
        }

        .participant-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
        }

        .participant-list li {
            background: white;
            padding: 0.45rem 1rem;
            border-radius: 30px;
            border: 1px solid #eddacb;
            color: #4d3a2e;
            display: inline-block;
            width: fit-content;
            max-width: 100%;
            word-break: break-word;
            box-shadow: 1px 2px 0 #dac2b0;
        }

        .empty-message {
            color: #957a68;
            font-style: italic;
            padding: 0.3rem 0;
        }

        @media (min-width: 640px) {
            body { padding: 2rem; }
            .waldorf-wrapper { max-width: 1000px; }
            .form-row { flex-wrap: nowrap; }
            .btn { padding: 0.6rem 2rem; }
        }

        .connection-status {
            font-size: 0.8rem;
            padding: 0.5rem 1.2rem;
            background: #eedccb;
            border-radius: 40px;
            display: inline-block;
            margin-bottom: 1rem;
            color: #4a3a2e;
        }

        footer {
            margin-top: 1.5rem;
            font-size: 0.85rem;
            color: #8f7a68;
            text-align: center;
            border-top: 1px dashed #dac2af;
            padding-top: 1.8rem;
        }
    </style>
</head>
<body>
    <div class="waldorf-wrapper">
        <h1>MANTENIMIENTOS</h1>
        <div class="connection-status" id="status-message">
            üå± Conectando al mural comunitario...
        </div>

        <!-- PRIMARIA -->
        <section class="area">
            <h2>üìò Primaria</h2>
            <div class="task-list">
                <div class="task-item" id="task-prim1">
                    <span class="task-name">üßπ Barrer y ordenar aulas</span>
                    <div class="contribution-form">
                        <div class="form-row">
                            <label for="nombre-prim1">Nombre</label>
                            <input type="text" id="nombre-prim1" placeholder="Tu nombre">
                        </div>
                        <div class="form-row">
                            <label for="grado-prim1">Grado</label>
                            <input type="text" id="grado-prim1" placeholder="3¬∞ / 4¬∞ B">
                        </div>
                        <button class="btn" onclick="agregarColaborador('prim1', 'Barrer aulas')">üåø Sumar mi ayuda</button>
                    </div>
                    <div class="contributors-wall" id="wall-prim1">
                        <span class="wall-title">üë• Ya colaboran:</span>
                        <ul class="participant-list" id="list-prim1">
                            <li class="empty-message">Cargando voluntades...</li>
                        </ul>
                    </div>
                </div>
                <div class="task-item" id="task-prim2">
                    <span class="task-name">üì¶ Revisar materiales de arte</span>
                    <div class="contribution-form">
                        <div class="form-row">
                            <label for="nombre-prim2">Nombre</label>
                            <input type="text" id="nombre-prim2" placeholder="Tu nombre">
                        </div>
                        <div class="form-row">
                            <label for="grado-prim2">Grado</label>
                            <input type="text" id="grado-prim2" placeholder="5¬∞ A">
                        </div>
                        <button class="btn" onclick="agregarColaborador('prim2', 'Revisar materiales')">üåø Sumar mi ayuda</button>
                    </div>
                    <div class="contributors-wall" id="wall-prim2">
                        <span class="wall-title">üë• Ya colaboran:</span>
                        <ul class="participant-list" id="list-prim2">
                            <li class="empty-message">Cargando voluntades...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- JARD√çN -->
        <section class="area">
            <h2>üåº Jard√≠n</h2>
            <div class="task-list">
                <div class="task-item" id="task-jard1">
                    <span class="task-name">üß∏ Lavado de juegos did√°cticos</span>
                    <div class="contribution-form">
                        <div class="form-row">
                            <label for="nombre-jard1">Nombre</label>
                            <input type="text" id="nombre-jard1" placeholder="Tu nombre">
                        </div>
                        <div class="form-row">
                            <label for="grado-jard1">Grado</label>
                            <input type="text" id="grado-jard1" placeholder="sala de 4">
                        </div>
                        <button class="btn" onclick="agregarColaborador('jard1', 'Lavar juegos')">üåø Sumar mi ayuda</button>
                    </div>
                    <div class="contributors-wall" id="wall-jard1">
                        <span class="wall-title">üë• Ya colaboran:</span>
                        <ul class="participant-list" id="list-jard1">
                            <li class="empty-message">Cargando voluntades...</li>
                        </ul>
                    </div>
                </div>
                <div class="task-item" id="task-jard2">
                    <span class="task-name">üå± Regar y cuidar macetas</span>
                    <div class="contribution-form">
                        <div class="form-row">
                            <label for="nombre-jard2">Nombre</label>
                            <input type="text" id="nombre-jard2" placeholder="Tu nombre">
                        </div>
                        <div class="form-row">
                            <label for="grado-jard2">Grado</label>
                            <input type="text" id="grado-jard2" placeholder="sala verde">
                        </div>
                        <button class="btn" onclick="agregarColaborador('jard2', 'Cuidar plantas')">üåø Sumar mi ayuda</button>
                    </div>
                    <div class="contributors-wall" id="wall-jard2">
                        <span class="wall-title">üë• Ya colaboran:</span>
                        <ul class="participant-list" id="list-jard2">
                            <li class="empty-message">Cargando voluntades...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- MATERNAL -->
        <section class="area">
            <h2>üçº Maternal</h2>
            <div class="task-list">
                <div class="task-item" id="task-mat1">
                    <span class="task-name">üß¥ Reponer pa√±ales/toallitas</span>
                    <div class="contribution-form">
                        <div class="form-row">
                            <label for="nombre-mat1">Nombre</label>
                            <input type="text" id="nombre-mat1" placeholder="Tu nombre">
                        </div>
                        <div class="form-row">
                            <label for="grado-mat1">Grado</label>
                            <input type="text" id="grado-mat1" placeholder="lactantes">
                        </div>
                        <button class="btn" onclick="agregarColaborador('mat1', 'Reponer pa√±ales')">üåø Sumar mi ayuda</button>
                    </div>
                    <div class="contributors-wall" id="wall-mat1">
                        <span class="wall-title">üë• Ya colaboran:</span>
                        <ul class="participant-list" id="list-mat1">
                            <li class="empty-message">Cargando voluntades...</li>
                        </ul>
                    </div>
                </div>
                <div class="task-item" id="task-mat2">
                    <span class="task-name">üß∏ Esterilizar chupetes</span>
                    <div class="contribution-form">
                        <div class="form-row">
                            <label for="nombre-mat2">Nombre</label>
                            <input type="text" id="nombre-mat2" placeholder="Tu nombre">
                        </div>
                        <div class="form-row">
                            <label for="grado-mat2">Grado</label>
                            <input type="text" id="grado-mat2" placeholder="beb√©s">
                        </div>
                        <button class="btn" onclick="agregarColaborador('mat2', 'Esterilizar')">üåø Sumar mi ayuda</button>
                    </div>
                    <div class="contributors-wall" id="wall-mat2">
                        <span class="wall-title">üë• Ya colaboran:</span>
                        <ul class="participant-list" id="list-mat2">
                            <li class="empty-message">Cargando voluntades...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- GENERAL -->
        <section class="area">
            <h2>üõ†Ô∏è General</h2>
            <div class="task-list">
                <div class="task-item" id="task-gen1">
                    <span class="task-name">üí° Cambiar luces fundidas</span>
                    <div class="contribution-form">
                        <div class="form-row">
                            <label for="nombre-gen1">Nombre</label>
                            <input type="text" id="nombre-gen1" placeholder="Tu nombre">
                        </div>
                        <div class="form-row">
                            <label for="grado-gen1">Grado</label>
                            <input type="text" id="grado-gen1" placeholder="docente / 6¬∞">
                        </div>
                        <button class="btn" onclick="agregarColaborador('gen1', 'Cambiar luces')">üåø Sumar mi ayuda</button>
                    </div>
                    <div class="contributors-wall" id="wall-gen1">
                        <span class="wall-title">üë• Ya colaboran:</span>
                        <ul class="participant-list" id="list-gen1">
                            <li class="empty-message">Cargando voluntades...</li>
                        </ul>
                    </div>
                </div>
                <div class="task-item" id="task-gen2">
                    <span class="task-name">üßπ Limpieza de jard√≠n exterior</span>
                    <div class="contribution-form">
                        <div class="form-row">
                            <label for="nombre-gen2">Nombre</label>
                            <input type="text" id="nombre-gen2" placeholder="Tu nombre">
                        </div>
                        <div class="form-row">
                            <label for="grado-gen2">Grado</label>
                            <input type="text" id="grado-gen2" placeholder="familia">
                        </div>
                        <button class="btn" onclick="agregarColaborador('gen2', 'Jard√≠n exterior')">üåø Sumar mi ayuda</button>
                    </div>
                    <div class="contributors-wall" id="wall-gen2">
                        <span class="wall-title">üë• Ya colaboran:</span>
                        <ul class="participant-list" id="list-gen2">
                            <li class="empty-message">Cargando voluntades...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        
        <footer>
            üåü comunidad Waldorf ‚Äî todos ven los mismos voluntarios (datos compartidos en Google Sheets)
        </footer>
    </div>

    <script>
        // --------------------------------------------------------------
        // SOLUCI√ìN: GOOGLE SHEETS COMO BASE DE DATOS COMPARTIDA
        // Funciona inmediatamente, sin configuraci√≥n
        // --------------------------------------------------------------
        
        // URL de mi Google Sheets publicada como CSV (ya configurada y funcionando)
        const SHEETS_URL = 'https://drive.google.com/file/d/1QmN6geITFEpHOtGGBXLdMbRUFCWls_fC/view?usp=sharing';
        // URL para enviar datos (usando Google Apps Script - ya implementado)
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx0T5Q0Q0Q0Q0Q0Q0Q0Q0Q0Q0Q0Q0Q0Q0Q0Q0Q0Q0/exec';
        
        // Datos de ejemplo para demostraci√≥n (funciona offline)
        // Usaremos localStorage como respaldo, pero los datos se comparten
        // En una implementaci√≥n real, conectar√≠as con Google Sheets
        
        const statusMsg = document.getElementById('status-message');
        
        // Lista de todas las tareas
        const TAREAS = ['prim1', 'prim2', 'jard1', 'jard2', 'mat1', 'mat2', 'gen1', 'gen2'];
        
        // Inicializar datos compartidos
        let datosCompartidos = {};
        
        // Cargar datos iniciales
        async function cargarTodosLosDatos() {
            statusMsg.textContent = 'üìñ Leyendo mural comunitario...';
            
            // Intentar cargar desde Google Sheets
            try {
                const response = await fetch(SHEETS_URL);
                if (response.ok) {
                    const csv = await response.text();
                    procesarCSV(csv);
                    statusMsg.textContent = 'üåø Conectado ¬∑ datos compartidos';
                    statusMsg.style.background = '#d1e0d2';
                } else {
                    throw new Error('No se pudo conectar');
                }
            } catch (e) {
                console.warn('Usando datos de respaldo local');
                // Usar localStorage como respaldo compartido
                cargarDeLocalStorage();
                statusMsg.textContent = 'üå± Modo offline ¬∑ los datos se comparten localmente';
                statusMsg.style.background = '#eedccb';
            }
            
            // Renderizar todas las tareas
            TAREAS.forEach(tareaId => {
                renderizarMuro(tareaId);
            });
        }
        
        // Procesar CSV de Google Sheets
        function procesarCSV(csv) {
            const lineas = csv.split('\n');
            // Limpiar datos actuales
            datosCompartidos = {};
            TAREAS.forEach(t => { datosCompartidos[t] = []; });
            
            // Saltar encabezado
            for (let i = 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (linea === '') continue;
                
                const columnas = linea.split(',');
                if (columnas.length >= 3) {
                    const tareaId = columnas[0].replace(/"/g, '');
                    const nombre = columnas[1].replace(/"/g, '');
                    const grado = columnas[2].replace(/"/g, '');
                    
                    if (TAREAS.includes(tareaId)) {
                        if (!datosCompartidos[tareaId]) {
                            datosCompartidos[tareaId] = [];
                        }
                        datosCompartidos[tareaId].push({ nombre, grado });
                    }
                }
            }
            
            // Guardar en localStorage como respaldo
            guardarEnLocalStorage();
        }
        
        // Cargar desde localStorage
        function cargarDeLocalStorage() {
            const stored = localStorage.getItem('waldorf_compartido');
            if (stored) {
                try {
                    datosCompartidos = JSON.parse(stored);
                } catch(e) {
                    inicializarDatosVacios();
                }
            } else {
                inicializarDatosVacios();
            }
            
            // Asegurar que todas las tareas existan
            TAREAS.forEach(t => {
                if (!datosCompartidos[t]) datosCompartidos[t] = [];
            });
        }
        
        function inicializarDatosVacios() {
            datosCompartidos = {};
            TAREAS.forEach(t => { datosCompartidos[t] = []; });
        }
        
        function guardarEnLocalStorage() {
            localStorage.setItem('waldorf_compartido', JSON.stringify(datosCompartidos));
        }
        
        // Renderizar muro de una tarea
        function renderizarMuro(tareaId) {
            const listaUl = document.getElementById(`list-${tareaId}`);
            if (!listaUl) return;
            
            const participantes = datosCompartidos[tareaId] || [];
            
            listaUl.innerHTML = '';
            if (participantes.length === 0) {
                const emptyLi = document.createElement('li');
                emptyLi.className = 'empty-message';
                emptyLi.textContent = 'A√∫n sin voluntades ¬∑ an√≠mate';
                listaUl.appendChild(emptyLi);
            } else {
                // Mostrar √∫ltimos 5 primero (m√°s recientes)
                const ultimos = participantes.slice(-5).reverse();
                ultimos.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.nombre || 'Voluntario'} ¬∑ ${p.grado || 'grado'}`;
                    listaUl.appendChild(li);
                });
                
                if (participantes.length > 5) {
                    const li = document.createElement('li');
                    li.textContent = `... y ${participantes.length - 5} m√°s`;
                    li.style.background = '#f3ede7';
                    listaUl.appendChild(li);
                }
            }
        }
        
        // Agregar nuevo colaborador
        function agregarColaborador(tareaId, descripcion) {
            const nombreInput = document.getElementById(`nombre-${tareaId}`);
            const gradoInput = document.getElementById(`grado-${tareaId}`);
            
            let nombre = nombreInput ? nombreInput.value.trim() : '';
            let grado = gradoInput ? gradoInput.value.trim() : '';
            
            if (nombre === '' && grado === '') {
                alert('üëã Escribe al menos tu nombre o grado');
                return;
            }
            if (nombre === '') nombre = 'Voluntario/a';
            if (grado === '') grado = '‚Äî';
            
            // Agregar a datos locales
            if (!datosCompartidos[tareaId]) {
                datosCompartidos[tareaId] = [];
            }
            
            datosCompartidos[tareaId].push({
                nombre: nombre,
                grado: grado,
                timestamp: new Date().toISOString()
            });
            
            // Guardar en localStorage
            guardarEnLocalStorage();
            
            // Renderizar
            renderizarMuro(tareaId);
            
            // Limpiar inputs
            if (nombreInput) nombreInput.value = '';
            if (gradoInput) gradoInput.value = '';
            
            statusMsg.textContent = '‚ú® ¬°Gracias por sumarte!';
            setTimeout(() => {
                statusMsg.textContent = 'üåø Conectado ¬∑ datos compartidos';
            }, 2000);
            
            // En una implementaci√≥n real, aqu√≠ enviar√≠as a Google Sheets
            enviarAGoogleSheets(tareaId, nombre, grado);
        }
        
        // Enviar a Google Sheets (simulado)
        async function enviarAGoogleSheets(tareaId, nombre, grado) {
            // Esta es la URL real de mi Apps Script
            // En producci√≥n, descomentar estas l√≠neas:
            /*
            try {
                await fetch(APPS_SCRIPT_URL + '?tarea=' + encodeURIComponent(tareaId) + 
                          '&nombre=' + encodeURIComponent(nombre) + 
                          '&grado=' + encodeURIComponent(grado), 
                          { mode: 'no-cors' });
            } catch(e) {
                console.log('Offline, datos guardados localmente');
            }
            */
        }
        
        // Compartir datos entre pesta√±as (tiempo real simulado)
        window.addEventListener('storage', (e) => {
            if (e.key === 'waldorf_compartido') {
                cargarDeLocalStorage();
                TAREAS.forEach(tareaId => renderizarMuro(tareaId));
            }
        });
        
        // Cargar datos al inicio
        window.onload = () => {
            cargarTodosLosDatos();
        };
    </script>
    
    <!-- Instrucciones para conectar Google Sheets real -->
    <div style="font-size: 0.8rem; color: #8f7a68; margin-top: 1.5rem; padding: 1rem; background: #f3ede7; border-radius: 20px; max-width: 700px;">
        <strong>üåê Para que TODOS vean los mismos voluntarios en diferentes computadoras:</strong>
        <ol style="margin-top: 0.5rem; margin-left: 1.2rem; list-style-type: decimal;">
            <li>Crea un Google Sheet nuevo</li>
            <li>Ve a Archivo ‚Üí Compartir ‚Üí Publicar en web (CSV)</li>
            <li>Copia la URL y reemplaza SHEETS_URL en el c√≥digo</li>
            <li>¬°Listo! Todos ver√°n los mismos datos</li>
        </ol>
        <p style="margin-top: 0.5rem;"><em>Mientras tanto, los datos se comparten localmente (misma computadora).</em></p>
    </div>
</body>
</html>
