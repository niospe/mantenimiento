<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Mantenimiento Waldorf Â· Jornada 9-15</title>
    <style>
        /* Mismo estilo Waldorf mobile-first */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: #faf4e9;
            font-family: 'Atkinson Hyperlegible', 'Segoe UI', sans-serif;
            line-height: 1.5;
            color: #3e2e23;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .waldorf-wrapper { max-width: 900px; width: 100%; }
        h1 {
            font-size: 2.2rem;
            font-weight: 400;
            text-transform: uppercase;
            color: #5e4b3a;
            border-bottom: 4px solid #dbb88c;
            display: inline-block;
            padding-bottom: 0.2rem;
            margin-bottom: 1.5rem;
            text-shadow: 2px 2px 0 rgba(235,205,167,0.3);
        }
        .area {
            background: rgba(255,247,240,0.8);
            border-radius: 32px 12px 32px 12px;
            padding: 1.5rem 1.2rem;
            margin-bottom: 2rem;
            border: 1px solid #e6d8c5;
        }
        h2 {
            font-size: 1.8rem;
            font-weight: 380;
            color: #7a5a44;
            border-left: 12px solid #c7aa82;
            padding-left: 0.75rem;
            margin-bottom: 0.6rem;
        }
        .subtitulo-detalle {
            font-size: 0.95rem;
            color: #8f6e5c;
            margin-bottom: 1.2rem;
            padding-left: 1.2rem;
            font-style: italic;
            border-left: 3px solid #e2cfbc;
        }
        .task-list { display: flex; flex-direction: column; gap: 1.3rem; }
        .task-item {
            background: #fffefc;
            padding: 1.1rem 1.2rem;
            border-radius: 20px 8px 20px 8px;
            border: 1px solid #eedccb;
            box-shadow: 4px 4px 0 #e2cfbc;
        }
        .task-name {
            font-weight: 650;
            font-size: 1.15rem;
            color: #4a3729;
            border-bottom: 1px dashed #d9b8a4;
            padding-bottom: 0.5rem;
            margin-bottom: 0.8rem;
        }
        .contribution-form {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
            margin: 0.8rem 0;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.4rem 0.8rem;
        }
        label {
            font-size: 0.9rem;
            color: #69554a;
            font-weight: 600;
            min-width: 60px;
        }
        input {
            background: #fefcf7;
            border: 1.5px solid #e3cebc;
            border-radius: 40px;
            padding: 0.7rem 1.1rem;
            font-size: 1rem;
            flex: 1 1 180px;
        }
        input:focus {
            border-color: #b4835c;
            outline: none;
            box-shadow: 0 0 0 3px rgba(180,140,100,0.15);
        }
        .btn {
            background: #ebdac9;
            border: none;
            border-radius: 50px;
            padding: 0.7rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: #3a2e25;
            border-bottom: 4px solid #bcaa96;
            align-self: flex-start;
            cursor: pointer;
            transition: 0.07s;
        }
        .btn:hover {
            background: #e2cfbc;
            border-bottom-width: 2px;
            transform: translateY(2px);
        }
        .contributors-wall {
            margin-top: 1.2rem;
            background: #f7efe7;
            padding: 1rem 1.2rem;
            border-radius: 18px;
            border-left: 8px solid #c6a882;
        }
        .wall-title {
            font-weight: 650;
            color: #624c3c;
            margin-bottom: 0.7rem;
        }
        .participant-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .participant-list li {
            background: white;
            padding: 0.45rem 1.2rem;
            border-radius: 30px;
            border: 1px solid #eddacb;
            width: fit-content;
            max-width: 100%;
            box-shadow: 1px 2px 0 #dac2b0;
        }
        .empty-message { color: #957a68; font-style: italic; }
        .connection-status {
            font-size: 0.8rem;
            padding: 0.5rem 1.2rem;
            background: #eedccb;
            border-radius: 40px;
            display: inline-block;
            margin-bottom: 1rem;
        }
        footer {
            margin-top: 2rem;
            text-align: center;
            color: #8f7a68;
            border-top: 1px dashed #dac2af;
            padding-top: 1.8rem;
        }
        @media (min-width: 640px) {
            body { padding: 2rem; }
            .waldorf-wrapper { max-width: 1100px; }
        }
    </style>
</head>
<body>
    <div class="waldorf-wrapper">
        <h1>MANTENIMIENTOS</h1>
        <div class="connection-status" id="status-message">
            ðŸŒ± Conectando al mural comunitario...
        </div>

        <!-- PRIMARIA - Materiales -->
        <section class="area">
            <h2>ðŸ“˜ Primaria</h2>
            <div class="subtitulo-detalle">Materiales y herramientas Â· maÃ±ana 9 a 15</div>
            <div class="task-list">
                <!-- Tarea 1 -->
                <div class="task-item">
                    <span class="task-name">ðŸ”¨ Percutora para sacar piso</span>
                    <div class="contribution-form">
                        <div class="form-row"><label>Nombre</label><input type="text" id="nombre-prim1" placeholder="quiÃ©n lleva"></div>
                        <div class="form-row"><label>Grado</label><input type="text" id="grado-prim1" placeholder="grado/familia"></div>
                        <button class="btn" onclick="agregarColaborador('prim1', 'Percutora para sacar piso')">ðŸŒ¿ Sumarme</button>
                    </div>
                    <div class="contributors-wall" id="wall-prim1">
                        <div class="wall-title">ðŸ‘¥ Colaboran:</div>
                        <ul class="participant-list" id="list-prim1"><li class="empty-message">Cargando...</li></ul>
                    </div>
                </div>
                <!-- Tarea 2 -->
                <div class="task-item">
                    <span class="task-name">ðŸŒ¿ Herramientas de jardinerÃ­a</span>
                    <div class="contribution-form">
                        <div class="form-row"><label>Nombre</label><input type="text" id="nombre-prim2"></div>
                        <div class="form-row"><label>Grado</label><input type="text" id="grado-prim2"></div>
                        <button class="btn" onclick="agregarColaborador('prim2', 'Herramientas de jardinerÃ­a')">ðŸŒ¿ Sumarme</button>
                    </div>
                    <div class="contributors-wall" id="wall-prim2">
                        <div class="wall-title">ðŸ‘¥ Colaboran:</div>
                        <ul class="participant-list" id="list-prim2"><li class="empty-message">Cargando...</li></ul>
                    </div>
                </div>
                <!-- Tarea 3 -->
                <div class="task-item">
                    <span class="task-name">ðŸ”© Taladro</span>
                    <div class="contribution-form">
                        <div class="form-row"><label>Nombre</label><input type="text" id="nombre-prim3"></div>
                        <div class="form-row"><label>Grado</label><input type="text" id="grado-prim3"></div>
                        <button class="btn" onclick="agregarColaborador('prim3', 'Taladro')">ðŸŒ¿ Sumarme</button>
                    </div>
                    <div class="contributors-wall" id="wall-prim3">
                        <div class="wall-title">ðŸ‘¥ Colaboran:</div>
                        <ul class="participant-list" id="list-prim3"><li class="empty-message">Cargando...</li></ul>
                    </div>
                </div>
                <!-- Tarea 4 -->
                <div class="task-item">
                    <span class="task-name">ðŸ“¦ Cinta doble faz 3M (40mts) para colgar cuadros</span>
                    <div class="contribution-form">
                        <div class="form-row"><label>Nombre</label><input type="text" id="nombre-prim4"></div>
                        <div class="form-row"><label>Grado</label><input type="text" id="grado-prim4"></div>
                        <button class="btn" onclick="agregarColaborador('prim4', 'Cinta doble faz 40m')">ðŸŒ¿ Sumarme</button>
                    </div>
                    <div class="contributors-wall" id="wall-prim4">
                        <div class="wall-title">ðŸ‘¥ Colaboran:</div>
                        <ul class="participant-list" id="list-prim4"><li class="empty-message">Cargando...</li></ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- AquÃ­ van TODAS las demÃ¡s secciones (JardÃ­n materiales, Maternal, JardÃ­n pendientes, Preescolar, General) -->
        <!-- Por espacio, no repito todo el HTML pero la estructura es IDÃ‰NTICA a la que ya funciona -->
        <!-- EN TU CÃ“DIGO ACTUAL, MANTENÃ‰S TODAS LAS TAREAS QUE YA TENÃ‰S -->
        <!-- SOLO CAMBIA LA PARTE DE JAVASCRIPT POR LA DE ABAJO -->

        <!-- ===== IMPORTANTE: MANTENÃ‰ TODAS TUS TAREAS EXISTENTES ===== -->
        <!-- AcÃ­ debajo va todo el HTML de tareas que ya tenÃ©s (JardÃ­n, Maternal, etc) -->
        <!-- Yo las omito por brevedad pero en tu pÃ¡gina ya estÃ¡n -->
        
        <footer>
            ðŸŒŸ Jornada Waldorf 9-15 Â· Datos compartidos en Google Sheets (todos ven lo mismo)
        </footer>
    </div>

    <script>
        // --------------------------------------------------------------
        // CONFIGURACIÃ“N - Â¡REEMPLAZA CON TUS URLs!
        // --------------------------------------------------------------
        const CONFIG = {
            // URL para LEER datos (CSV pÃºblico)
            CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSxvEliqsj2N2PbI8qXaUcMSem0vBUrXdo5ucBYsySuYqxGvJHNMS6BBhLIcGthrmRVx1Up1iSJ2SdM/pub?gid=634978238&single=true&output=csv',
            
            // URL para ESCRIBIR datos (Apps Script)
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxwqP_mX7t0vKsiP12GvkaUphGTHSuw5oHRwAigG1MuxJnVsVccCjiJR6wBtfjIB5huQA/exec'
        };

        // Todas las tareas (IDs) - MANTENÃ‰ LA LISTA COMPLETA DE TUS TAREAS
        const TAREAS = [
            'prim1', 'prim2', 'prim3', 'prim4',
            'jard-mat1', 'jard-mat2', 'jard-mat3', 'jard-mat4', 'jard-mat5', 'jard-mat6', 'jard-mat7', 'jard-mat8',
            'mat1', 'mat2', 'mat3',
            'jard-pen1', 'jard-pen2', 'jard-pen3', 'jard-pen4', 'jard-pen5', 'jard-pen6', 'jard-pen7',
            'pre1', 'pre2', 'pre3', 'pre4',
            'gen1', 'gen2', 'gen3', 'gen4', 'gen5'
        ];

        // Estado de la aplicaciÃ³n
        let colaboradores = {};
        const statusMsg = document.getElementById('status-message');

        // Inicializar estructura
        TAREAS.forEach(t => colaboradores[t] = []);

        // --------------------------------------------------------------
        // FUNCIÃ“N 1: LEER DATOS DESDE GOOGLE SHEETS (CSV)
        // --------------------------------------------------------------
        async function cargarDatos() {
            try {
                statusMsg.textContent = 'ðŸ“– Leyendo mural comunitario...';
                const response = await fetch(CONFIG.CSV_URL);
                const csv = await response.text();
                
                // Resetear datos
                TAREAS.forEach(t => colaboradores[t] = []);
                
                // Parsear CSV (simple, sin comillas)
                const lineas = csv.split('\n');
                for (let i = 1; i < lineas.length; i++) {
                    if (!lineas[i].trim()) continue;
                    
                    const cols = lineas[i].split(',');
                    if (cols.length >= 3) {
                        const tareaId = cols[0].replace(/"/g, '').trim();
                        const nombre = cols[1].replace(/"/g, '').trim();
                        const grado = cols[2].replace(/"/g, '').trim();
                        
                        if (TAREAS.includes(tareaId)) {
                            colaboradores[tareaId].push({ nombre, grado });
                        }
                    }
                }
                
                statusMsg.textContent = 'âœ… Conectado a Google Sheets Â· datos en tiempo real';
                statusMsg.style.background = '#d1e0d2';
            } catch (error) {
                console.error('Error cargando CSV:', error);
                statusMsg.textContent = 'âš ï¸ No se pudo conectar a Google Sheets. Usando cachÃ© local.';
                statusMsg.style.background = '#eedccb';
                
                // Intentar cargar desde localStorage como respaldo
                const local = localStorage.getItem('waldorf_colaboradores');
                if (local) {
                    try {
                        colaboradores = JSON.parse(local);
                    } catch(e) {}
                }
            }
            
            // Actualizar todas las listas
            TAREAS.forEach(t => renderizarMuro(t));
        }

        // --------------------------------------------------------------
        // FUNCIÃ“N 2: GUARDAR DATOS EN GOOGLE SHEETS (Apps Script)
        // --------------------------------------------------------------
        async function guardarEnGoogleSheets(tareaId, nombre, grado) {
            try {
                // Usar no-cors para evitar problemas CORS
                const url = `${CONFIG.APPS_SCRIPT_URL}?tarea=${encodeURIComponent(tareaId)}&nombre=${encodeURIComponent(nombre)}&grado=${encodeURIComponent(grado)}&ts=${Date.now()}`;
                
                await fetch(url, {
                    mode: 'no-cors',
                    method: 'GET'
                });
                
                console.log('âœ… Dato enviado a Google Sheets');
                return true;
            } catch (error) {
                console.error('Error enviando a Google Sheets:', error);
                return false;
            }
        }

        // --------------------------------------------------------------
        // FUNCIÃ“N 3: AGREGAR COLABORADOR (llamada desde botones)
        // --------------------------------------------------------------
        window.agregarColaborador = async function(tareaId, descripcion) {
            // Obtener inputs
            const nombreInput = document.getElementById(`nombre-${tareaId}`);
            const gradoInput = document.getElementById(`grado-${tareaId}`);
            
            let nombre = nombreInput ? nombreInput.value.trim() : '';
            let grado = gradoInput ? gradoInput.value.trim() : '';
            
            // Validar
            if (!nombre && !grado) {
                alert('ðŸ‘‹ Escribe al menos tu nombre');
                return;
            }
            
            nombre = nombre || 'Voluntario';
            grado = grado || 'â€”';
            
            // 1. Guardar LOCALMENTE (para verlo ya)
            if (!colaboradores[tareaId]) colaboradores[tareaId] = [];
            colaboradores[tareaId].push({ nombre, grado });
            
            // 2. Guardar en localStorage (respaldo)
            localStorage.setItem('waldorf_colaboradores', JSON.stringify(colaboradores));
            
            // 3. Renderizar inmediatamente
            renderizarMuro(tareaId);
            
            // 4. Limpiar inputs
            if (nombreInput) nombreInput.value = '';
            if (gradoInput) gradoInput.value = '';
            
            // 5. Enviar a Google Sheets (en segundo plano)
            statusMsg.textContent = 'ðŸ“¤ Guardando en mural comunitario...';
            const exito = await guardarEnGoogleSheets(tareaId, nombre, grado);
            
            if (exito) {
                statusMsg.textContent = 'âœ¨ Â¡Gracias! Tu colaboraciÃ³n ya es visible para todos';
                setTimeout(() => statusMsg.textContent = 'âœ… Conectado a Google Sheets', 3000);
            } else {
                statusMsg.textContent = 'âš ï¸ Guardado localmente. Se sincronizarÃ¡ despuÃ©s.';
                setTimeout(() => statusMsg.textContent = 'ðŸŒ¿ Modo offline Â· datos locales', 3000);
            }
        };

        // --------------------------------------------------------------
        // FUNCIÃ“N 4: RENDERIZAR MURO DE UNA TAREA
        // --------------------------------------------------------------
        function renderizarMuro(tareaId) {
            const listaUl = document.getElementById(`list-${tareaId}`);
            if (!listaUl) return;
            
            const participantes = colaboradores[tareaId] || [];
            
            listaUl.innerHTML = '';
            
            if (participantes.length === 0) {
                listaUl.innerHTML = '<li class="empty-message">AÃºn sin voluntades Â· animate</li>';
                return;
            }
            
            // Mostrar Ãºltimos 5
            const ultimos = participantes.slice(-5).reverse();
            ultimos.forEach(p => {
                const li = document.createElement('li');
                li.textContent = `${p.nombre} Â· ${p.grado}`;
                listaUl.appendChild(li);
            });
            
            if (participantes.length > 5) {
                const li = document.createElement('li');
                li.textContent = `... y ${participantes.length - 5} mÃ¡s`;
                li.style.background = '#f3ede7';
                listaUl.appendChild(li);
            }
        }

        // --------------------------------------------------------------
        // INICIALIZAR
        // --------------------------------------------------------------
        window.onload = () => {
            cargarDatos();
            
            // Refrescar cada 30 segundos para ver nuevos datos
            setInterval(cargarDatos, 30000);
            
            // Escuchar cambios en localStorage (misma compu)
            window.addEventListener('storage', (e) => {
                if (e.key === 'waldorf_colaboradores') {
                    cargarDatos();
                }
            });
        };
    </script>
</body>
</html>
