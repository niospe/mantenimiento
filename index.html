<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <title>Mantenimiento Waldorf ¬∑ Jornada 9-15</title>
    <style>
        /* ESTILO WALDORF - MOBILE FIRST */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #faf4e9;
            font-family: 'Atkinson Hyperlegible', 'Segoe UI', Roboto, -apple-system, sans-serif;
            line-height: 1.5;
            color: #3e2e23;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .waldorf-wrapper {
            max-width: 1000px;
            width: 100%;
        }

        h1 {
            font-size: 2.2rem;
            font-weight: 400;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #5e4b3a;
            border-bottom: 4px solid #dbb88c;
            display: inline-block;
            padding-bottom: 0.2rem;
            margin-bottom: 1.5rem;
            margin-top: 0.2rem;
            text-shadow: 2px 2px 0 rgba(235, 205, 167, 0.3);
            word-break: break-word;
        }

        .connection-status {
            font-size: 0.8rem;
            padding: 0.5rem 1.2rem;
            background: #eedccb;
            border-radius: 40px;
            display: inline-block;
            margin-bottom: 1rem;
            color: #4a3a2e;
        }

        /* =========== P√ÅGINA PRINCIPAL - CATEGOR√çAS =========== */
        .categorias-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .categoria-card {
            background: rgba(255, 247, 240, 0.8);
            border-radius: 32px 12px 32px 12px;
            padding: 1.5rem 1.2rem;
            box-shadow: 0 8px 18px -6px rgba(120, 90, 70, 0.12);
            border: 1px solid #e6d8c5;
            transition: transform 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .categoria-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(120, 90, 70, 0.2);
            background: #fffcf5;
        }

        .categoria-icono {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .categoria-nombre {
            font-size: 1.8rem;
            font-weight: 380;
            color: #7a5a44;
            margin-bottom: 0.3rem;
            border-left: 8px solid #c7aa82;
            padding-left: 0.75rem;
        }

        .categoria-descripcion {
            font-size: 0.95rem;
            color: #8f6e5c;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .categoria-stats {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #5e4b3a;
            border-top: 1px dashed #d9b8a4;
            padding-top: 0.8rem;
        }

        .btn-volver {
            background: #ebdac9;
            border: none;
            border-radius: 50px;
            padding: 0.7rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: #3a2e25;
            border-bottom: 4px solid #bcaa96;
            transition: 0.07s;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5cfbc;
            border-bottom-width: 4px;
            text-decoration: none;
            margin-bottom: 1.5rem;
        }

        .btn-volver:hover {
            background: #e2cfbc;
            border-bottom-width: 2px;
            transform: translateY(2px);
            border-bottom-color: #9f8b7a;
        }

        /* =========== P√ÅGINA DE TAREAS =========== */
        .area {
            background: rgba(255, 247, 240, 0.8);
            border-radius: 32px 12px 32px 12px;
            padding: 1.5rem 1.2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 18px -6px rgba(120, 90, 70, 0.12);
            border: 1px solid #e6d8c5;
        }

        h2 {
            font-size: 1.8rem;
            font-weight: 380;
            color: #7a5a44;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-left: 12px solid #c7aa82;
            padding-left: 0.75rem;
            line-height: 1.2;
        }

        .subtitulo-detalle {
            font-size: 0.95rem;
            font-weight: 400;
            color: #8f6e5c;
            margin-top: -0.2rem;
            margin-bottom: 1.2rem;
            padding-left: 1.2rem;
            font-style: italic;
            border-left: 3px solid #e2cfbc;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 1.3rem;
        }

        .task-item {
            background: #fffefc;
            padding: 1.1rem 1.2rem;
            border-radius: 20px 8px 20px 8px;
            border: 1px solid #eedccb;
            box-shadow: 4px 4px 0 #e2cfbc;
        }

        .task-name {
            font-weight: 650;
            font-size: 1.15rem;
            color: #4a3729;
            display: block;
            margin-bottom: 0.8rem;
            border-bottom: 1px dashed #d9b8a4;
            padding-bottom: 0.5rem;
        }

        .contribution-form {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
            margin: 0.8rem 0 0.6rem;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.4rem 0.8rem;
        }

        label {
            font-size: 0.9rem;
            color: #69554a;
            font-weight: 600;
            min-width: 60px;
        }

        input {
            background: #fefcf7;
            border: 1.5px solid #e3cebc;
            border-radius: 40px;
            padding: 0.7rem 1.1rem;
            font-size: 1rem;
            flex: 1 1 180px;
            font-family: inherit;
            transition: 0.2s;
        }

        input:focus {
            border-color: #b4835c;
            outline: none;
            background-color: #fff9f2;
            box-shadow: 0 0 0 3px rgba(180, 140, 100, 0.15);
        }

        .btn {
            background: #ebdac9;
            border: none;
            border-radius: 50px;
            padding: 0.7rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: #3a2e25;
            border-bottom: 4px solid #bcaa96;
            align-self: flex-start;
            transition: 0.07s;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5cfbc;
            border-bottom-width: 4px;
        }

        .btn:hover {
            background: #e2cfbc;
            border-bottom-width: 2px;
            transform: translateY(2px);
            border-bottom-color: #9f8b7a;
        }

        .contributors-wall {
            margin-top: 1.2rem;
            background: #f7efe7;
            padding: 1rem 1.2rem;
            border-radius: 18px;
            border-left: 8px solid #c6a882;
            font-size: 0.95rem;
        }

        .wall-title {
            font-weight: 650;
            color: #624c3c;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.7rem;
            font-size: 1rem;
        }

        .participant-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .participant-list li {
            background: white;
            padding: 0.45rem 1.2rem;
            border-radius: 30px;
            border: 1px solid #eddacb;
            color: #4d3a2e;
            display: inline-block;
            width: fit-content;
            max-width: 100%;
            word-break: break-word;
            box-shadow: 1px 2px 0 #dac2b0;
        }

        .empty-message {
            color: #957a68;
            font-style: italic;
            padding: 0.3rem 0;
        }

        .loading-spinner {
            text-align: center;
            padding: 3rem;
            color: #8f6e5c;
            font-size: 1.2rem;
        }

        footer {
            margin-top: 2rem;
            font-size: 0.85rem;
            color: #8f7a68;
            text-align: center;
            border-top: 1px dashed #dac2af;
            padding-top: 1.8rem;
        }
    </style>
</head>
<body>
    <div class="waldorf-wrapper" id="app">
        <!-- El contenido se renderiza din√°micamente -->
    </div>

    <script>
        // --------------------------------------------------------------
        // CONFIGURACI√ìN - ¬°REEMPLAZA CON TUS URLs DE GOOGLE SHEETS!
        // --------------------------------------------------------------
        const CONFIG = {
            // Hoja de "Tareas" - Debe tener columnas: id, categoriaId, categoriaNombre, categoriaDescripcion, categoriaIcono, tareaNombre
            TAREAS_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0DLBlzR3AM8qIPNvX5782yxhY44a0DnTidE8SHsWyxG8g2qWBphy1FQP5Ykx-0Ycv9wdjrWJx6cXS/pub?gid=0&single=true&output=csv',
            
            // Hoja de "Colaboradores" - Debe tener columnas: tareaId, nombre, grado
            COLABORADORES_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSxvEliqsj2N2PbI8qXaUcMSem0vBUrXdo5ucBYsySuYqxGvJHNMS6BBhLIcGthrmRVx1Up1iSJ2SdM/pub?gid=634978238&single=true&output=csv',
            
            // Apps Script para guardar nuevos colaboradores
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxwqP_mX7t0vKsiP12GvkaUphGTHSuw5oHRwAigG1MuxJnVsVccCjiJR6wBtfjIB5huQA/exec'
        };

        // Estado de la aplicaci√≥n
        let appState = {
            categorias: [],           // Lista de categor√≠as √∫nicas
            tareas: [],               // Todas las tareas con su categor√≠a
            colaboradores: {},         // { tareaId: [{nombre, grado}] }
            currentView: 'home',       // 'home' o 'categoria'
            currentCategoriaId: null   // ID de categor√≠a seleccionada
        };

        const statusMsg = document.getElementById('status-message');
        const appEl = document.getElementById('app');

        // --------------------------------------------------------------
        // CARGAR DATOS DESDE GOOGLE SHEETS
        // --------------------------------------------------------------
        async function cargarDatosIniciales() {
            try {
                actualizarStatus('üìñ Leyendo tareas y colaboradores...');
                
                // Cargar tareas y colaboradores en paralelo
                const [tareasCSV, colaboradoresCSV] = await Promise.all([
                    fetch(CONFIG.TAREAS_CSV_URL).then(res => res.text()),
                    fetch(CONFIG.COLABORADORES_CSV_URL).then(res => res.text())
                ]);
                
                // Procesar tareas y construir categor√≠as
                procesarTareas(tareasCSV);
                
                // Procesar colaboradores
                procesarColaboradores(colaboradoresCSV);
                
                // Guardar en localStorage
                localStorage.setItem('waldorf_datos_completos', JSON.stringify(appState));
                
                actualizarStatus('‚úÖ Datos cargados desde Google Sheets');
                
                // Renderizar vista actual
                renderizarApp();
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                actualizarStatus('‚ö†Ô∏è Usando datos guardados localmente');
                
                // Intentar cargar desde localStorage
                const local = localStorage.getItem('waldorf_datos_completos');
                if (local) {
                    try {
                        appState = JSON.parse(local);
                    } catch(e) {}
                }
                
                renderizarApp();
            }
        }

        // Procesar CSV de tareas
        function procesarTareas(csv) {
            const lineas = csv.split('\n');
            const categoriasMap = new Map();
            const tareas = [];
            
            // Asumimos primera l√≠nea como encabezados
            for (let i = 1; i < lineas.length; i++) {
                if (!lineas[i].trim()) continue;
                
                const cols = lineas[i].split(',').map(c => c.replace(/"/g, '').trim());
                if (cols.length >= 6) {
                    const [id, categoriaId, categoriaNombre, categoriaDescripcion, categoriaIcono, tareaNombre] = cols;
                    
                    // Guardar categor√≠a si no existe
                    if (!categoriasMap.has(categoriaId)) {
                        categoriasMap.set(categoriaId, {
                            id: categoriaId,
                            nombre: categoriaNombre,
                            descripcion: categoriaDescripcion,
                            icono: categoriaIcono
                        });
                    }
                    
                    // Guardar tarea
                    tareas.push({
                        id: id,
                        categoriaId: categoriaId,
                        nombre: tareaNombre
                    });
                }
            }
            
            appState.categorias = Array.from(categoriasMap.values());
            appState.tareas = tareas;
        }

        // Procesar CSV de colaboradores
        function procesarColaboradores(csv) {
            const colaboradores = {};
            
            // Inicializar todas las tareas con array vac√≠o
            appState.tareas.forEach(t => colaboradores[t.id] = []);
            
            const lineas = csv.split('\n');
            for (let i = 1; i < lineas.length; i++) {
                if (!lineas[i].trim()) continue;
                
                const cols = lineas[i].split(',').map(c => c.replace(/"/g, '').trim());
                if (cols.length >= 3) {
                    const [tareaId, nombre, grado] = cols;
                    
                    if (colaboradores[tareaId]) {
                        colaboradores[tareaId].push({ nombre, grado });
                    }
                }
            }
            
            appState.colaboradores = colaboradores;
        }

        // --------------------------------------------------------------
        // GUARDAR EN GOOGLE SHEETS (Apps Script)
        // --------------------------------------------------------------
        async function guardarEnGoogleSheets(tareaId, nombre, grado) {
            try {
                const url = `${CONFIG.APPS_SCRIPT_URL}?tarea=${encodeURIComponent(tareaId)}&nombre=${encodeURIComponent(nombre)}&grado=${encodeURIComponent(grado)}&ts=${Date.now()}`;
                
                await fetch(url, { mode: 'no-cors', method: 'GET' });
                console.log('‚úÖ Dato enviado a Google Sheets');
                return true;
            } catch (error) {
                console.error('Error enviando a Google Sheets:', error);
                return false;
            }
        }

        // --------------------------------------------------------------
        // AGREGAR COLABORADOR
        // --------------------------------------------------------------
        window.agregarColaborador = async function(tareaId) {
            const nombreInput = document.getElementById(`nombre-${tareaId}`);
            const gradoInput = document.getElementById(`grado-${tareaId}`);
            
            let nombre = nombreInput ? nombreInput.value.trim() : '';
            let grado = gradoInput ? gradoInput.value.trim() : '';
            
            if (!nombre && !grado) {
                alert('üëã Escribe al menos tu nombre');
                return;
            }
            
            nombre = nombre || 'Voluntario';
            grado = grado || '‚Äî';
            
            // Actualizar estado
            if (!appState.colaboradores[tareaId]) {
                appState.colaboradores[tareaId] = [];
            }
            appState.colaboradores[tareaId].push({ nombre, grado });
            
            // Guardar en localStorage
            localStorage.setItem('waldorf_datos_completos', JSON.stringify(appState));
            
            // Renderizar la tarea espec√≠fica
            const tarea = appState.tareas.find(t => t.id === tareaId);
            if (tarea && appState.currentCategoriaId === tarea.categoriaId) {
                renderizarTarea(tareaId);
            }
            
            // Limpiar inputs
            if (nombreInput) nombreInput.value = '';
            if (gradoInput) gradoInput.value = '';
            
            // Enviar a Google Sheets
            actualizarStatus('üì§ Guardando colaboraci√≥n...');
            await guardarEnGoogleSheets(tareaId, nombre, grado);
            actualizarStatus('‚ú® ¬°Gracias por sumarte!');
            setTimeout(() => actualizarStatus('‚úÖ Conectado a Google Sheets'), 2000);
        };

        // Renderizar una tarea espec√≠fica
        function renderizarTarea(tareaId) {
            const listaUl = document.getElementById(`list-${tareaId}`);
            if (!listaUl) return;
            
            const participantes = appState.colaboradores[tareaId] || [];
            
            listaUl.innerHTML = '';
            
            if (participantes.length === 0) {
                const emptyLi = document.createElement('li');
                emptyLi.className = 'empty-message';
                emptyLi.textContent = 'A√∫n sin voluntades ¬∑ animate';
                listaUl.appendChild(emptyLi);
                return;
            }
            
            const ultimos = participantes.slice(-5).reverse();
            ultimos.forEach(p => {
                const li = document.createElement('li');
                li.textContent = `${p.nombre} ¬∑ ${p.grado}`;
                listaUl.appendChild(li);
            });
            
            if (participantes.length > 5) {
                const li = document.createElement('li');
                li.textContent = `... y ${participantes.length - 5} m√°s`;
                li.style.background = '#f3ede7';
                listaUl.appendChild(li);
            }
        }

        // --------------------------------------------------------------
        // FUNCIONES DE NAVEGACI√ìN
        // --------------------------------------------------------------
        function irAHome() {
            appState.currentView = 'home';
            appState.currentCategoriaId = null;
            renderizarApp();
            window.history.pushState({ view: 'home' }, '', '#');
        }

        function irACategoria(categoriaId) {
            appState.currentView = 'categoria';
            appState.currentCategoriaId = categoriaId;
            renderizarApp();
            window.history.pushState({ view: 'categoria', id: categoriaId }, '', `#${categoriaId}`);
        }

        // --------------------------------------------------------------
        // RENDERIZADO PRINCIPAL
        // --------------------------------------------------------------
        function renderizarApp() {
            if (appState.currentView === 'home') {
                appEl.innerHTML = renderHome();
            } else {
                appEl.innerHTML = renderCategoria();
            }
        }

        function renderHome() {
            const categorias = appState.categorias;
            
            let html = `
                <h1>MANTENIMIENTOS</h1>
                <div class="connection-status" id="status-message">
                    üå± Conectado al mural comunitario...
                </div>
                
                <div class="categorias-grid">
            `;
            
            categorias.forEach(cat => {
                // Contar tareas en esta categor√≠a
                const tareasCategoria = appState.tareas.filter(t => t.categoriaId === cat.id);
                
                // Contar colaboraciones totales
                let totalColaboraciones = 0;
                tareasCategoria.forEach(t => {
                    totalColaboraciones += (appState.colaboradores[t.id] || []).length;
                });
                
                html += `
                    <a class="categoria-card" onclick="irACategoria('${cat.id}')">
                        <div class="categoria-icono">${cat.icono}</div>
                        <div class="categoria-nombre">${cat.nombre}</div>
                        <div class="categoria-descripcion">${cat.descripcion}</div>
                        <div class="categoria-stats">
                            üõ†Ô∏è ${tareasCategoria.length} tareas ¬∑ 
                            üë• ${totalColaboraciones} voluntarios
                        </div>
                    </a>
                `;
            });
            
            html += `
                </div>
                <footer>
                    üåü Jornada Waldorf ¬∑ Hac√© clic en cada categor√≠a para ver las tareas
                </footer>
            `;
            
            return html;
        }

        function renderCategoria() {
            const categoria = appState.categorias.find(c => c.id === appState.currentCategoriaId);
            if (!categoria) {
                irAHome();
                return '';
            }
            
            const tareasCategoria = appState.tareas.filter(t => t.categoriaId === categoria.id);
            
            let html = `
                <button class="btn-volver" onclick="irAHome()">‚Üê Volver a categor√≠as</button>
                <h1>${categoria.icono} ${categoria.nombre}</h1>
                <div class="connection-status" id="status-message">
                    üå± ${categoria.descripcion}
                </div>
            `;
            
            tareasCategoria.forEach(tarea => {
                html += `
                    <div class="area">
                        <h2>${tarea.nombre}</h2>
                        <div class="task-item">
                            <div class="contribution-form">
                                <div class="form-row">
                                    <label>Nombre</label>
                                    <input type="text" id="nombre-${tarea.id}" placeholder="tu nombre">
                                </div>
                                <div class="form-row">
                                    <label>Grado</label>
                                    <input type="text" id="grado-${tarea.id}" placeholder="grado/familia">
                                </div>
                                <button class="btn" onclick="agregarColaborador('${tarea.id}')">üåø Sumarme</button>
                            </div>
                            <div class="contributors-wall" id="wall-${tarea.id}">
                                <span class="wall-title">üë• Colaboran:</span>
                                <ul class="participant-list" id="list-${tarea.id}"></ul>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <button class="btn-volver" onclick="irAHome()">‚Üê Volver a categor√≠as</button>
                <footer>
                    üåü Jornada Waldorf ¬∑ Tu colaboraci√≥n se guarda en el mural comunitario
                </footer>
            `;
            
            return html;
        }

        // Actualizar mensaje de estado y re-renderizar si es necesario
        function actualizarStatus(mensaje) {
            const statusEl = document.getElementById('status-message');
            if (statusEl) {
                statusEl.textContent = mensaje;
            }
        }

        // Inicializar
        window.onload = () => {
            cargarDatosIniciales();
            
            // Manejar navegaci√≥n con historial
            window.onpopstate = (event) => {
                if (event.state) {
                    if (event.state.view === 'home') {
                        appState.currentView = 'home';
                        appState.currentCategoriaId = null;
                    } else if (event.state.view === 'categoria') {
                        appState.currentView = 'categoria';
                        appState.currentCategoriaId = event.state.id;
                    }
                    renderizarApp();
                }
            };
            
            // Verificar si hay hash en la URL al cargar
            if (window.location.hash) {
                const categoriaId = window.location.hash.substring(1);
                const categoria = appState.categorias.find(c => c.id === categoriaId);
                if (categoria) {
                    appState.currentView = 'categoria';
                    appState.currentCategoriaId = categoriaId;
                }
            }
        };

        // Hacer funciones globales
        window.irAHome = irAHome;
        window.irACategoria = irACategoria;
    </script>
</body>
</html>
